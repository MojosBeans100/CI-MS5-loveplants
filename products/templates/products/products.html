{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid products-container">
    <div class="margin">
        <!-- product filters choice -->
        <div class="row m-md-4r">
            <div class="col-md-8 offset-md-2">

                <!-- plant type filters -->
                <div>
                    <div class="d-flex">
                        <hr class="flex-grow-1">
                        <h2 class="text-center px-2 px-md-3 px-xl-5">PLANTS</h2>
                        <hr class="flex-grow-1">
                    </div>

                    <p class="text-center">Filter by plant type</p>

                    <!-- plant types list choice - images credit "https://www.flaticon.com/free-icons/plant" Plant icons created by Icongeek26 - Flaticon -->
                    <div class="row">
                        <div class="text-center col-md col-4 d-flex justify-content-around py-2">
                            <a class="anchor-no-decoration"
                                href="{% url 'products' %}?{{current_filters}}&plant_cats=Hanging">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Hanging' %}
                                <img src="{% static 'media/hanging_bold.png' %}" title="Hanging plants">
                                {% else %}
                                <img src="{% static 'media/hanging.png' %}" title="Hanging plants">
                                <!-- onmouseover="boldImage(this);" onmouseout="unboldImage(this);" -->
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="{% static 'media/hanging.png' %}" title="Hanging plants">
                                {% endif %}
                                <br><br><small>Hanging</small></a>
                        </div>
                        <div class="text-center col-md col-4 d-flex justify-content-around py-2">
                            <a class="anchor-no-decoration"
                                href="{% url 'products' %}?{{current_filters}}&plant_cats=Floor">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Floor' %}
                                <img src="{% static 'media/floor_bold.png' %}" title="Floor plants">
                                {% else %}
                                <img src="{% static 'media/floor.png' %}" title="Floor plants">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="{% static 'media/floor.png' %}" title="Floor plants">
                                {% endif %}
                                <br><br><small>Floor</small></a>
                        </div>
                        <div class="text-center col-md col-4 d-flex justify-content-around py-2">
                            <a class="anchor-no-decoration"
                                href="{% url 'products' %}?{{current_filters}}&plant_cats=Potted">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Potted' %}
                                <img src="{% static 'media/potted_bold.png' %}" title="Potted plants">
                                {% else %}
                                <img src="{% static 'media/potted.png' %}" title="Potted plants">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="{% static 'media/potted.png' %}" title="Potted plants">
                                {% endif %}
                                <br><br><small>Potted</small></a>
                        </div>
                        <div class="text-center col-md col-6 d-flex justify-content-around py-2">
                            <a class="anchor-no-decoration"
                                href="{% url 'products' %}?{{current_filters}}&plant_cats=Flowers">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Flowers' %}
                                <img src="{% static 'media/flowers_bold.png' %}" title="Plants with flowers">
                                {% else %}
                                <img src="{% static 'media/flowers.png' %}" title="Plants with flowers">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="{% static 'media/flowers.png' %}" title="Plants with flowers">
                                {% endif %}
                                <br><br><small>Flowers</small></a>
                        </div>
                        <div class="text-center col-md col-6 d-flex justify-content-around py-2">
                            <a class="anchor-no-decoration"
                                href="{% url 'products' %}?{{current_filters}}&plant_cats=Succulents">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Succulents' %}<img src="{% static 'media/succulent_bold.png' %}"
                                    title="Succulents">
                                {% else %}
                                <img src="{% static 'media/succulent.png' %}" title="Succulent plants">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="{% static 'media/succulent.png' %}" title="Succulent plants">
                                {% endif %}
                                <br><br><small>Succulents</small></a>
                        </div>
                    </div>
                    <hr>

                </div>

                <!-- other filters -->
                <div class="row">
                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="dropdown extra-filter">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                Price
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=0,20">£0 - £20</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=20,30">£20 - £30</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=30,40">£30 - £40</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=40,50">£40 - £50</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=50">£50+</a></li>
                            </ul>
                            {% for filter in front_end_filters %}
                            {% if filter.0 == 'price' %}
                            <p class="text-center filter">{{filter.2|title}}</p>
                            {% endif %}
                            {% endfor %}

                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="dropdown extra-filter">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
                                Sunlight required
                            </button>
                            <ul class="dropdown-menu border-0" aria-labelledby="dropdownMenuButton2">
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&sunlight=low">Low <i
                                            class="fa-solid fa-cloud"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&sunlight=med">Medium <i
                                            class="fa-solid fa-cloud-sun"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&sunlight=high">High <i
                                            class="fa-solid fa-sun"></i></a></li>
                            </ul>
                            {% for filter in front_end_filters %}
                            {% if filter.0 == 'sunlight' %}
                            <p class="text-center filter">{{filter.2|title}}</p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="dropdown extra-filter">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
                                Watering required
                            </button>
                            <ul class="dropdown-menu border-0" aria-labelledby="dropdownMenuButton3">
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&watering=low">Low <i
                                            class="fa-solid fa-droplet"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&watering=med">Medium <i
                                            class="fa-solid fa-cloud-rain"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&watering=high">High <i
                                            class="fa-solid fa-cloud-showers-heavy"></i></a></li>
                            </ul>
                            {% for filter in front_end_filters %}
                            {% if filter.0 == 'watering' %}
                            <p class="text-center filter">{{filter.2|title}}</p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="extra-filter">
                            <button onClick="location.href='{% url 'products' %}?{{current_filters}}&rare'"
                                class="btn btn-outline-secondary">Rare</button>
                            {% for filter in front_end_filters %}
                            {% if filter == 'Rare' %}
                            <p class="text-center filter"><i class="fa-solid fa-gem"></i></p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4  d-flex justify-content-center py-1">
                        <div class="extra-filter">
                            <button onClick="location.href='{% url 'products' %}?{{current_filters}}&popular'"
                                class="btn btn-outline-secondary">Popular</button>
                            {% for filter in front_end_filters %}
                            {% if filter == 'Popular' %}
                            <p class="text-center filter"><i class="fa-solid fa-bolt"></i></p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    {% if user.is_superuser %}
                    <div class="col-12 col-sm-6 col-xl-4  d-flex justify-content-center py-1">
                        <div class="extra-filter">
                            <a href="{% url 'products' %}?{{current_filters}}&liveonsite"><button
                                    class="btn btn-outline-secondary w-100">Live on site</button></a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <p class="text-center"><a href="{% url 'products' %}"><em>Clear all <i
                                class="ps-2 fa-solid fa-xmark"></i></em></a></p>

                {% if user.is_superuser %}
                <div class="row my-4 d-flex justify-content-evenly">
                    <div class="col col-md-6 col-xl-4">
                        <a href="{% url 'add_product' %}"><button class="w-100 btn admin text-white">Add product <i
                                    class="ps-3 fa-solid fa-plus"></i></button></a>
                    </div>

                    <div class="col col-md-6 col-xl-4">
                        <a href="{% url 'create_sale' %}"><button class="w-100 btn admin text-white">Create sale <i
                                    class="ps-3 fa-solid fa-bell"></i></button></a>
                    </div>
                </div>
                {% else %}
                {% endif %}

            </div>
        </div>
        <hr>
        <!-- products list -->
        <div class="row">
            <div class="col">

                <!-- number of products, products per page, sort  -->
                <div class="row px-1 align-items-center">

                    <div
                        class="col-12 col-sm-4 align-items-center d-flex order-2 order-sm-1 justify-content-sm-start justify-content-center">
                        <div class="p-2">
                            <p>{{all_products.count}} products</p>
                        </div>
                    </div>

                    <div class="col-12 col-sm-4 align-items-center order-3 order-sm-2 justify-content-center">
                        <form method="GET" class="p-0 w-100" action="{% url 'products' %}">
                            <div class="row">
                                <div class="col-10"><input type="text" class="p-0 ps-2 border-0 border-bottom w-100"
                                        placeholder="Search for products" name="q"></div>
                                <div class="col-2"><button class="btn p-0" type="submit">
                                        <i class="ps-2 fa-solid fa-magnifying-glass"></i></button></div>
                            </div>
                        </form><br>

                    </div>

                    <div
                        class="col-12 col-sm-4 align-items-center p-2 d-flex order-sm-3 justify-content-center order-1 justify-content-sm-end">
                        <div class="dropdown">
                            <a class="btn dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                {% if current_sorting == 'None_None' %}Sort products:{% endif %}
                                {% if current_sorting == 'price_asc' %}Price (low to high){% endif %}
                                {% if current_sorting == 'price_desc' %}Price (high to low){% endif %}
                                {% if current_sorting == 'rating_asc' %}Rating (low to high){% endif %}
                                {% if current_sorting == 'rating_desc' %}Rating (high to low){% endif %}
                                {% if current_sorting == 'name_asc' %}Name (A-Z){% endif %}
                                {% if current_sorting == 'name_desc' %}Name (Z-A){% endif %}
                            </a>

                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?{{current_filters}}&sort=price&direction=asc">Price
                                        (low-high)</a></li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?{{current_filters}}&sort=price&direction=desc">Price
                                        (high-low)</a></li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?{{current_filters}}&sort=average_rating&direction=asc">Rating
                                        (low-high)</a>
                                </li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?{{current_filters}}&sort=average_rating&direction=desc">Rating
                                        (high-low)</a>
                                </li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?{{current_filters}}&sort=name&direction=asc">Name
                                        (A-Z)</a></li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?{{current_filters}}&sort=name&direction=desc">Name
                                        (Z-A)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- the users search query -->
                {% if search_query != None %}
                <div class="row text-center">
                    <h4>"{{search_query}}"</h4>

                    {% if all_products.count == 0 %}
                    <p>No products found: try searching by a different term
                    </p>
                    <p class="text-center"><a href="{% url 'products' %}"><em>Clear<i
                                    class="ps-2 fa-solid fa-xmark"></i></em></a></p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- list the products -->
    <div class="row">
        {% for product in page_obj %}
        <div class="col-sm-6 col-lg-3 d-flex justify-content-center">

            <!-- product card -->
            <div class="product-card card text-center border-0 py-3">

                <!-- product image -->
                <div id="product-image">

                    {% if user.is_authenticated %}
                    <form method="POST" action="{% url 'product_like' product.id %}" class="form product-like">
                        {% csrf_token %}
                        <button id="{{product.id}}" class="product-like-button" onclick="likeProduct(this);">
                            {% if product.friendly_name in liked_list %}
                            <div class="like-icon">
                                <i class="fa-solid fa-heart"></i>

                            </div>
                            {% else %}
                            <div class="like-icon">
                                <i id="product-like-icon" class="fa-solid fa-heart"></i>
                            </div>
                            {% endif %}
                        </button>
                        <input type="hidden" name="redirect_url" value="{{ request.path }}">
                    </form>
                    {% else %}
                    {% endif %}

                    {% if product.image2_source_url %}
                    <a href="{% url 'product_detail' product.id %}">
                        <img onmouseover="hoverImage(this)" onmouseout="unHoverImage(this)"
                            id="{{product.image2_source_url}}" title="{{product.image1_source_url}}"
                            src="{{product.image1_source_url}}" class="card-img-top rounded-0"
                            alt="{{product.friendly_name}} | {{product.latin_name}}"></a>
                    {% else %}
                    <a href="{% url 'product_detail' product.id %}">
                        <img title="{{product.image1_source_url}}" src="{{product.image1_source_url}}"
                            class="card-img-top rounded-0" alt="{{product.friendly_name}} | {{product.latin_name}}"></a>
                    {% endif %}
                </div>

                <!-- product name and price -->
                <div class="card-body text-start">
                    <a href="{% url 'product_detail' product.id %}">
                        <h5 class="card-title">{{product.friendly_name|upper}} {{product.average_rating}}
                            {% if user.is_superuser %}({{product.stock_quantity}}){% endif %}</h5>
                    </a>
                    {% if product.latin_name %}
                    <p><em><small>{{product.latin_name}}</small></em></p>
                    {% else %}
                    {% endif %}
                    {% if product.sale_price %}
                    <p class="card-text"><del>£{{product.price}}</del>&nbsp; £{{product.sale_price}}</p>
                    {% else %}
                    <p class="card-text">£{{product.price}}</p>
                    {% endif %}

                </div>

                {% if user.is_superuser %}
                {% if product.live_on_site == False %}
                <p class="text-danger">Live on site <i class="fa-solid fa-xmark"></i></p>
                {% else %}
                <p class="text-success">Live on site <i class="fa-solid fa-check"></i></p>
                {% endif %}
                {% else %}
                {% endif %}

                <!-- {% if user.is_superuser %}
                    <div class="row">
                        <div class="col">
                            <button class="btn w-100 admin text-white">Copy <i
                                    class="px-1 fa-solid fa-copy"></i></button>
                        </div>
                        <div class="col">
                            <a href="{% url 'edit_product' product.id %}"><button
                                    class="btn w-100 admin text-white">Edit <i
                                        class="px-1 fa-solid fa-pen-to-square"></i></button></a>
                        </div>
                    </div>
                    {% else %}
                    {% endif %} -->
            </div>
        </div>

        {% endfor %}
    </div>

    <!-- pagination -->
    <div class="pagination">
        <span class="step-links">

            {% if page_obj.has_previous %}
            <a href="?page=1">&laquo; first</a>
            <a href="?page={{ page_obj.previous_page_number }}">previous</a>
            {% endif %}

            <span class="current">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
            {% endif %}

        </span>
    </div>
</div>

{% endblock %}

{% block postloadjs %}
{{block.super}}
<script>
    /*jshint esversion: 6 */

    // function boldImage(element) {
    //     console.log(element.src)
    //     element.src = element.src.split('.png')[0] + '_bold' + '.png';
    // }

    // function unboldImage(element) {
    //     element.src = element.src.replace('_bold', "");
    //     console.log(element.src)
    // }

    // prevent form from refreshing the page
    var i;
    var forms = document.getElementsByClassName('product-like');
    for (i = 0; i < forms.length; i++) {
        forms[i].addEventListener('submit', function (ev) {
            ev.preventDefault();
        });
    }

    /**
     * Post 'like' form to view and color icons appropriately
     */
    function likeProduct(element) {

        // organise form variables
        var csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
        var id = parseInt(element.id);
        var url = `/products/product_like/${id}`;
        var redirect_url = '/products/products.html'

        // post to the view
        var response = fetch(url, {
            method: 'POST',
            headers: {
                "X-CSRFToken": csrfToken
            }
        });

        // change the color of the product
        if (element.childNodes[1].childNodes[1].style.color == 'white') {
            element.childNodes[1].childNodes[1].style.color = 'black';
        } else {
            element.childNodes[1].childNodes[1].style.color = 'white';
        }
    }

    /**
    Display different product image on hover
    */
    function hoverImage(element) {

        if (element.id !== 'None') {
            element.src = element.id;
        } else {}
    }

    /**
    Revert to original image on 'unhover'
    */
    function unHoverImage(element) {
        element.src = element.title;
    }
</script>
{% endblock %}