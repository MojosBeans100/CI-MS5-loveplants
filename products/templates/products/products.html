{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="margin">
        <!-- product filters choice -->
        <div class="row m-md-4r">
            <div class="col-md-8 col-lg-6 offset-lg-3 offset-md-2">

                <!-- plant type filters -->
                <div>

                    <div class="d-flex">
                        <hr class="flex-grow-1">
                        <h2 class="text-center px-2 px-md-3 px-xl-5">PLANTS</h2>
                        <hr class="flex-grow-1">
                    </div>

                    <p class="text-center">Filter by plant type</p>

                    <!-- plant types list choice - images credit "https://www.flaticon.com/free-icons/plant" Plant icons created by Icongeek26 - Flaticon -->
                    <div class="row">
                        <div class="text-center col-md col-4 d-flex justify-content-around py-2">
                            <a href="{% url 'products' %}?{{current_filters}}&plant_cats=Hanging">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Hanging' %}
                                <img src="/static/media/hanging_bold.png" title="Hanging plants">
                                {% else %}
                                <img src="/static/media/hanging.png" title="Hanging plants">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="/static/media/hanging.png" title="Hanging plants">
                                {% endif %}
                                <br><br><small>Hanging</small></a>
                        </div>
                        <div class="text-center col-md col-4 d-flex justify-content-around py-2">
                            <a href="{% url 'products' %}?{{current_filters}}&plant_cats=Floor">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Floor' %}
                                <img src="/static/media/floor_bold.png" title="Floor plants">
                                {% else %}
                                <img src="/static/media/floor.png" title="Floor plants">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="/static/media/floor.png" title="Floor plants">
                                {% endif %}
                                <br><br><small>Floor</small></a>
                        </div>
                        <div class="text-center col-md col-4 d-flex justify-content-around py-2">
                            <a href="{% url 'products' %}?{{current_filters}}&plant_cats=Potted">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Potted' %}
                                <img src="/static/media/potted_bold.png" title="Potted plants">
                                {% else %}
                                <img src="/static/media/potted.png" title="Potted plants">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="/static/media/potted.png" title="Potted plants">
                                {% endif %}
                                <br><br><small>Potted</small></a>
                        </div>
                        <div class="text-center col-md col-6 d-flex justify-content-around py-2">
                            <a href="{% url 'products' %}?{{current_filters}}&plant_cats=Flowers">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Flowers' %}<img src="/static/media/flower_bold.png"
                                    title="Plants with flowers">
                                {% else %}
                                <img src="/static/media/flowers.png" title="Plants with flowers">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="/static/media/flowers.png" title="Plants with flowers">
                                {% endif %}
                                <br><br><small>Flowers</small></a>
                        </div>
                        <div class="text-center col-md col-6 d-flex justify-content-around py-2">
                            <a href="{% url 'products' %}?{{current_filters}}&plant_cats=Succulents">
                                {% if front_end_filters|length > 0 %}
                                {% for filter in front_end_filters %}
                                {% if filter.0 == 'plant_cats' %}
                                {% if filter.1 == 'Succulents' %}<img src="/static/media/succulent_bold.png"
                                    title="Succulents">
                                {% else %}
                                <img src="/static/media/succulent.png" title="Succulent plants">
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <img src="/static/media/succulent.png" title="Succulent plants">
                                {% endif %}
                                <br><br><small>Succulents</small></a>
                        </div>
                    </div>
                    <hr>

                </div>

                <!-- other filters -->
                <div class="row">
                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="dropdown extra-filter">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                Price
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=0,20">£0 - £20</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=20,30">£20 - £30</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=30,40">£30 - £40</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=40,50">£40 - £50</a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&price=50">£50+</a></li>
                            </ul>
                            {% for filter in front_end_filters %}
                            {% if filter.0 == 'price' %}
                            <p class="text-center filter">{{filter.2|title}}</p>
                            {% endif %}
                            {% endfor %}

                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="dropdown extra-filter">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                Sunlight required
                            </button>
                            <ul class="dropdown-menu border-0" aria-labelledby="dropdownMenuButton1">
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&sunlight=low">Low <i
                                            class="fa-solid fa-cloud"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&sunlight=med">Medium <i
                                            class="fa-solid fa-cloud-sun"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&sunlight=high">High <i
                                            class="fa-solid fa-sun"></i></a></li>
                            </ul>
                            {% for filter in front_end_filters %}
                            {% if filter.0 == 'sunlight' %}
                            <p class="text-center filter">{{filter.2|title}}</p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="dropdown extra-filter">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                Watering required
                            </button>
                            <ul class="dropdown-menu border-0" aria-labelledby="dropdownMenuButton1">
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&watering=low">Low <i
                                            class="fa-solid fa-droplet"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&watering=med">Medium <i
                                            class="fa-solid fa-cloud-rain"></i></a></li>
                                <li class="text-center list-group-item flex-fill border-0"><a
                                        href="{% url 'products' %}?{{current_filters}}&watering=high">High <i
                                            class="fa-solid fa-cloud-showers-heavy"></i></a></li>
                            </ul>
                            {% for filter in front_end_filters %}
                            {% if filter.0 == 'watering' %}
                            <p class="text-center filter">{{filter.2|title}}</p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4 d-flex justify-content-center py-1">
                        <div class="extra-filter">
                            <a href="{% url 'products' %}?{{current_filters}}&rare"><button
                                    class="btn btn-outline-secondary">Rare</button></a>
                            {% for filter in front_end_filters %}
                            {% if filter == 'Rare' %}
                            <p class="text-center filter"><i class="fa-solid fa-gem"></i></p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-xl-4  d-flex justify-content-center py-1">
                        <div class="extra-filter">
                            <a href="{% url 'products' %}?{{current_filters}}&popular"><button
                                    class="btn btn-outline-secondary">Popular</button></a>
                            {% for filter in front_end_filters %}
                            {% if filter == 'Popular' %}
                            <p class="text-center filter"><i class="fa-solid fa-bolt"></i></p>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <p class="text-center"><a href="{% url 'products' %}"><em>Clear all filters</em></a></p>

                {% if user.is_superuser %}
                <div class="row my-4 d-flex justify-content-evenly">
                    <div class="col-3">
                        <a href="{% url 'add_product' %}"><button class="w-100 btn admin text-white">Add product <i
                                    class="ps-3 fa-solid fa-plus"></i></button></a>
                    </div>
                    <div class="col-3">
                        <a href="{% url 'products' %}?admin_view_all"><button class="w-100 btn admin text-white">View
                                all products <i class="ps-3 fa-solid fa-list"></i></button></a>
                    </div>
                    <div class="col-3">
                        <a href="#"><button class="w-100 btn admin text-white">Create sale <i class="ps-3 fa-solid fa-bell"></i></button></a>
                    </div>
                </div>
                {% else %}
                {% endif %}
            </div>
        </div>

        <!-- products list -->
        <div class="row">
            <div class="col">

                <!-- number of products, products per page, sort  -->
                <div class="row align-items-center">
                    <hr>

                    <div class="col-12 col-sm-4 col-md-6 p-2 text-center">
                        {% if all_products.count == 0 %}
                        <h3>No products found, try widening your search!</h3>
                        {% else %}
                        <h3>{{all_products.count}} products</h3>
                        {% endif %}
                    </div>

                    <div class="col-12 col-sm-4 col-md-6 p-2 d-flex justify-content-center justify-content-md-end">
                        <div class="dropdown border">
                            <a class="btn dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                {% if current_sorting == 'None_None' %}Sort products:{% endif %}
                                {% if current_sorting == 'price_asc' %}Price (low to high){% endif %}
                                {% if current_sorting == 'price_desc' %}Price (high to low){% endif %}
                                {% if current_sorting == 'rating_asc' %}Rating (low to high){% endif %}
                                {% if current_sorting == 'rating_desc' %}Rating (high to low){% endif %}
                                {% if current_sorting == 'name_asc' %}Name (A-Z){% endif %}
                                {% if current_sorting == 'name_desc' %}Name (Z-A){% endif %}
                                {% if current_sorting == 'category_asc' %}Category (A-Z){% endif %}
                                {% if current_sorting == 'category_desc' %}Category (Z-A){% endif %}
                            </a>

                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?sort=price&direction=asc{{current_filters}}">Price
                                        (low-high)</a></li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?sort=price&direction=desc{{current_filters}}">Price
                                        (high-low)</a></li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?sort=average_rating&direction=asc">Rating
                                        (low-high)</a>
                                </li>
                                <li><a class="dropdown-item"
                                        href="{% url 'products' %}?sort=average_rating&direction=desc">Rating
                                        (high-low)</a>
                                </li>
                                <li><a class="dropdown-item" href="{% url 'products' %}?sort=name&direction=asc">Name
                                        (A-Z)</a></li>
                                <li><a class="dropdown-item" href="{% url 'products' %}?sort=name&direction=desc">Name
                                        (Z-A)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- the users search query -->
                {% if search_query != None %}
                <div class="row text-center">
                    <h4>{{all_products.count}} results for "{{search_query}}"</h4>

                    {% if all_products.count == 0 %}
                    <p>Try searching by a different term</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- list the products -->
        <div class="row">
            {% for product in page_obj %}
            <div class="col-sm-6 col-lg-3 d-flex justify-content-center">

                <!-- product card -->
                <div class="card text-center border-0 py-5" style="width: 20rem;">

                    <!-- product image -->
                    <div style="position: relative;">

                        {% if user.is_authenticated %}
                        <form method="POST" action="{% url 'product_like' product.id %}" class="form product-like">
                            {% csrf_token %}
                            <button id="{{product.id}}" class="product-like-button" onclick="likeProduct(this);">
                                {% if product.friendly_name in liked_list %}
                                <div class="like-icon">
                                    <i class="fa-solid fa-heart"></i>

                                </div>
                                {% else %}
                                <div class="like-icon">
                                    <i style="position: absolute; color: white; z-index: -99"
                                        class="fa-solid fa-heart"></i>
                                </div>
                                {% endif %}
                            </button>
                            <input style="width: 0; height: 0;" type="hidden" name="redirect_url"
                                value="{{ request.path }}">
                        </form>
                        {% else %}
                        {% endif %}

                        <a href="{% url 'product_detail' product.id %}">
                            <img onmouseover="hoverImage(this)" onmouseout="unHoverImage(this)"
                                id="{{product.image2_source_url}}" title="{{product.image1_source_url}}"
                                src="{{product.image1_source_url}}" class="card-img-top rounded-0"
                                alt="{{product.friendly_name}} product image"></a>
                    </div>

                    <!-- product name and price -->
                    <div class="card-body text-start">
                        <a href="{% url 'product_detail' product.id %}">
                            <h5 class="card-title">{{product.friendly_name|upper}}</h5>
                        </a>
                        {% if product.latin_name %}
                        <p><em><small>{{product.latin_name}}</small></em></p>
                        {% else %}
                        {% endif %}
                        {% if product.sale_price %}
                        <p class="card-text"><del>£{{product.price}}</del> £{{product.sale_price}}</p>
                        {% else %}
                        <p class="card-text">£{{product.price}}</p>
                        {% endif %}

                    </div>

                    <!-- {% if user.is_superuser %}
                    <div class="row">
                        <div class="col">
                            <button class="btn w-100 admin text-white">Copy <i
                                    class="px-1 fa-solid fa-copy"></i></button>
                        </div>
                        <div class="col">
                            <a href="{% url 'edit_product' product.id %}"><button
                                    class="btn w-100 admin text-white">Edit <i
                                        class="px-1 fa-solid fa-pen-to-square"></i></button></a>
                        </div>
                    </div>
                    {% else %}
                    {% endif %} -->
                </div>
            </div>

            {% endfor %}
        </div>

        <!-- pagination -->
        <div class="pagination">
            <span class="step-links">
                {% if page_obj.has_previous %}
                <a href="?page=1">&laquo; first</a>
                <a href="?page={{ page_obj.previous_page_number }}">previous</a>
                {% endif %}

                <span class="current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                </span>

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
                {% endif %}
            </span>
        </div>
    </div>
</div>

{% endblock %}

{% block postloadjs %}
<script>
    /*jshint esversion: 6 */

    // prevent form from refreshing the page
    var i;
    var forms = document.getElementsByClassName('product-like');
    for (i = 0; i < forms.length; i++) {
        forms[i].addEventListener('submit', function (ev) {
            ev.preventDefault();
        });
    }

    /**
     * Post 'like' form to view and color icons appropriately
     */
    function likeProduct(element) {

        // organise form variables
        var csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
        var id = parseInt(element.id);
        var url = `/products/product_like/${id}`;

        // post to the view
        var response = fetch(url, {
            method: 'POST',
            headers: {
                "X-CSRFToken": csrfToken
            }
        });

        // change the color of the product
        if (element.childNodes[1].childNodes[1].style.color == 'white') {
            element.childNodes[1].childNodes[1].style.color = 'black';
        } else {
            element.childNodes[1].childNodes[1].style.color = 'white';
        }
    }

    /**
    Display different product image on hover
    */
    function hoverImage(element) {

        if (element.id !== 'None') {
            element.src = element.id;
        } else {}
    }

    /**
    Revert to original image on 'unhover'
    */
    function unHoverImage(element) {
        element.src = element.title;
    }
</script>
{% endblock %}