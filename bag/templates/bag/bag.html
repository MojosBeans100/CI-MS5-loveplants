{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">

    {% if product_count == 0 %}
    {% else %}
    <div class="row">
        <p><i class="fa-solid fa-arrow-left-long"></i> <a href="{% url 'products' %}">Continue shopping</a></p>
    </div>
    {% endif %}

    <div class="row">
        <h2>Your basket ({{product_count}})</h2>

        {% if free_delivery_delta > 0 and product_count != 0 %}
        <p class="text-center">Spend £{{free_delivery_delta}} more to qualify for free shipping!</p>
        {% else %}
        <p class="text-center">You have qualified for free shipping!</p>
        {% endif %}

        <div class="col-8">

            {% if product_count == 0 %}
            <p>Your basket is currently empty.</p>
            {% else %}

            <!-- product list table -->
            <table class="table table-borderless">
                <thead>
                    <tr>
                        <th></th>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>

                <!-- list items -->
                <tbody>
                    {% for item in bag_items %}
                    <tr class="align-middle">
                        <td>
                            <a href="{% url 'product_detail' item.product.id %}"><img
                                    style="width:300px; height: 300px;" src="{{item.product.image1_source_url}}"></a>
                        </td>
                        <td><a href="{% url 'product_detail' item.product.id %}">{{item.product.friendly_name}} |
                                {{item.product.pot_size}}cm</a></td>
                        <td class="item_price">{{item.product.price}}</td>
                        <td>
                            <form class="form update-basket border" method="POST"
                                action="{% url 'edit_bag' item.item_id %}">
                                {% csrf_token %}
                                <input type="number" value={{item.quantity}} min=1 max={{item.product.stock_quantity}}
                                    name="quantity" id="{{item.item_id}}" class="item_quantity form-control"
                                    onchange="userUpdate();">
                            </form>
                            <div>
                                <a href="#" onclick="updateItem();" class="update-item">Update</a>
                                <a href="#" onclick="removeItem(this);" class="remove-item" id="{{item.item_id}}">|
                                    Remove</a>
                            </div>
                        </td>
                        <td class="item_subtotal"></td>
                    </tr>
                    {% endfor %}

                    <tr id="bag-table-line" class="text-end">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>Subtotal:</td>
                        <td>£{{total}}</td>
                    </tr>

                    <tr class="text-end">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>Delivery:</td>
                        <td>£{{delivery}}</td>
                    </tr>

                    <tr class="text-end">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>Grand Total:</td>
                        <td>£{{grand_total}}</td>
                    </tr>

                </tbody>
            </table>
            {% endif %}
        </div>
        <div class="col-4">

        </div>
    </div>

    <!-- suggest products around the price of the free delivery delta -->
    {% if free_delivery_delta > 0 %}
    <h4>Spend £{{free_delivery_delta}} more to qualify for free delivery!</h4>
    <div class="row">
        {% for product in free_delivery_products %}
        <div class="col-sm-4 col-lg-3">

            <a href="{% url 'product_detail' product.id %}"><img style="width:100%; height:60%" class="p-3"
                    src="{{product.image1_source_url}}"></a>
            <a href="{% url 'product_detail' product.id %}">
                <p class="text-center"><strong>{{product.friendly_name}}</strong></p>
                <p class="text-center">£{{product.price}}</p>
            </a>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock content %}

{% block postloadjs %}
<script>
    let original_quantities = [];

    /**
    collect all original quantities for products
    */
    document.addEventListener('DOMContentLoaded', () => {
        updateSubtotals();
        products_quantities = document.getElementsByClassName('item_quantity')
        for (i = 0; i < products_quantities.length; i++) {
            original_quantities.push(products_quantities[i].value)
        }
    });

    /**
    if user updates an item quantity, update the form
    */
    function userUpdate() {
        products_quantities = document.getElementsByClassName('item_quantity')
        update_buttons = document.getElementsByClassName('update-item')

        for (i = 0; i < products_quantities.length; i++) {

            // if user has changed the original quantity
            if (parseInt(products_quantities[i].value) != original_quantities[i]) {

                // if the quantity is between 1 and max items in stock
                if ((parseInt(products_quantities[i].value)) > 0 && (parseInt(products_quantities[i].value)) <=
                    parseInt(
                        max_values[i].max)) {

                    // submit the update form
                    updateItem(i);

                    // update the subtotals
                    products_subtotals[i].innerHTML = ((parseInt(products_quantities[i].value)) * (parseFloat(
                        products_prices[i].innerHTML))).toFixed(2)

                    // if quantity is outwith acceptable range
                } else {

                    // remove subtotal and change quantity back to original value
                    products_subtotals[i].innerHTML = (original_quantities[i] * (parseFloat(
                        products_prices[i].innerHTML))).toFixed(2)
                    products_quantities[i].value = original_quantities[i]
                }

            }
        }
    }

    /**
    calculate original subtotals on page load
    */
    function updateSubtotals() {
        products_prices = document.getElementsByClassName('item_price')
        products_quantities = document.getElementsByClassName('item_quantity')
        products_subtotals = document.getElementsByClassName('item_subtotal')
        max_values = document.getElementsByClassName('item_quantity')

        for (i = 0; i < products_prices.length; i++) {

            if ((parseInt(products_quantities[i].value)) > 0 && (parseInt(products_quantities[i].value)) <= parseInt(
                    max_values[i].max)) {

                products_subtotals[i].innerHTML = ((parseInt(products_quantities[i].value)) * (parseFloat(
                    products_prices[i].innerHTML))).toFixed(2)
            } else {
                products_subtotals[i].innerHTML = ""
                products_quantities[i].value = original_quantities[i]
            }
        }
    }

    /**
    submit the relevant update form
    */
    function updateItem(item_num) {
        form = document.getElementsByClassName('update-basket')[item_num]
        form.submit()
        updateSubtotals();
    }

    function removeItem(item_id) {

        items_in_basket = document.getElementsByClassName('remove-item')

        for (i = 0; i < items_in_basket.length; i++) {
            if (items_in_basket[i].id == item_id.id) {
                item_to_remove = document.getElementById(item_id.id)
                console.log(item_to_remove)
                item_to_remove.setAttribute('value', 0)
                console.log(item_to_remove.value)
                form = document.getElementsByClassName('update-basket')[i]
                console.log(form)
                form.submit()
                updateSubtotals();
            }
        }
    }
</script>
{% endblock %}